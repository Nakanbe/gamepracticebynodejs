<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <title>chk</title>
</head>
<body onload="do_first();">
  <div id='theSelect'>
  </div>
  <div>
    <table border=1 style="text-align:center;" id="show">
        <tr>
          <td>開賽時間（start_dt+start_time）</td>
          <td>內容（聯盟中文名稱<br>主隊中文名稱 VS 客隊中文名稱</td>
          <td>比分（主 VS 客）</td>
          <td>功能</td>
        </tr>
    </table>
  </div>
</body>
</html>

<script>
  
  var webid_arr = {
    '1': 'sportslottery',
    '2': 'jingcai',
    '3': '7sport',
    '4': '8betsport',
    '5': 'foot-bet-9',
    '6': 'foot-bet-10',
    '7': 'bedminton-11',
    '8': 'bedminton-12'
  }
  
  var gtype = {
    "BS":"美棒",
    "BK":"籃球",
    "FT":"足球",
    "CB":"中華職棒",
    "KB":"其他棒球",
    "JB":"日棒",
    "AF":"美足",
    "IB":"冰球",
    "LO":"彩球",
    "ST":"指數",
    "WB":"其他籃球",
    "EB":"電競",
    "EK":"國際籃球",
    "EF":"國際足球",
    "TN":"網球",
    "VB":"排球",
    "PO":"板球",
    "HB":"手球",
    "BM":"羽毛球",
    "BL":"撞球",
    "GD":"賽馬/賽狗"
  }

  //第一次進入網站 
  function do_first(){
    var webid_sel = select_create(webid_arr, 'web');  //產生下拉式選單
    var sport_sel = select_create(gtype, 'sport');    //產生下拉式選單
    $('#theSelect').append(webid_sel+sport_sel);  
    getData();
  }
  //第一次進入網站 <td></td><td></td><td></td><td></td>
  
  //當下拉式選單有改變時，會觸發這個函式
  function getData(){
    var webid = document.getElementById("web").value;
    var gametype = document.getElementById("sport").value;
    var gameid = -1;  //預設-1
    if(event.type == 'click'){  //按下刪除
      var x = event.target; //.parentNode.parentNode;
      while(x.tagName!='TR') x = x.parent;
      x <-- tr
      gameid = x.attributes[0].value;
      x.remove();
    }
    $.ajax({
      type: 'POST',
      url: 'db.php',
      data: {
        gameid: gameid,
        webid: webid,
        gametype: gametype
      },
      datatype: 'JSON',
      error: function(xhr, ajaxOptions, thrownError){
        console.log(ajaxOptions);
        output( [] );
      },
      success: function(data, status, xhr){  
        if(gameid == -1){  //當不是刪除時
          try{
            if(!data[0].hasOwnProperty('game_id')) throw 'ERROR';
          }
          catch(err){
            console.log(err);
            data = [];
          }
          finally{
            output(data);
          }
          ////
          if(data[0] && data[0].hasOwnProperty('game_id')) {
          }
          else {
            console.log(err);
            data = [];

          }
          output(data);
        }
      },
      beforeSend: function(){  //在資料回傳前把select disable掉
        $('#theSelect select').attr({disabled: 'disabled'});
      },
      complete: function(){   //收到回傳資料後就可以用了
        $('#theSelect select').removeAttr('disabled');
      }
    });
  }
  
  
  //產生下拉式選單
  function select_create(arr, id){
    var str = '<select id="'+id+'" onchange="getData()">';
    for(var key in arr){  //option用loop印出來
      str += '<option value="'+key+'"> ' + arr[key] + ' </option>';
    }
    str += '</select>';
    return str;
  }
  
  //先刪除多出來的row，row數不夠加上去，在把內容更新
  function output(data){
    var showTable = $('#show');
  
    //table row的數量，-1是因為第一行不用算
    var table_row = showTable[0].rows.length-1;  
     
    if(table_row > data.length){   //當資料長度小於row的數量，把多出來的row刪掉
      for(var i = table_row; i > data.length; i--){
        showTable[0].rows[i].remove();
      }
    }
    else if(table_row < data.length){  //當資料長度大於row的數量，印新的row出來
      for(var i = table_row; i < data.length; i++){
        showTable.append('<tr id="'+data[i]['game_id']+'"> <td></td> <td></td> <td></td> <td></td> </tr>');
      }
    }

    //更新row裡的資料
    for(var i = 0; i < data.length; i++){
      showTable[0].rows[i+1].cells[0].innerHTML = data[i]['date_time'];
      showTable[0].rows[i+1].cells[1].innerHTML = data[i]['league_name'] + '<br>' + data[i]['home_name'] + '[主] VS ' + data[i]['cust_name'];
      showTable[0].rows[i+1].cells[2].innerHTML = data[i]['home_s'] + ':' + data[i]['cust_s'];
      showTable[0].rows[i+1].cells[3].innerHTML  = '<input type="button" value="刪除" onclick="getData()">';  
    }
  }
   
  //10秒自動更新
  //setInterval(getData, 10000);
  
</script>